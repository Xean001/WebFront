<div class="container-fluid py-5">
  <!-- Encabezado -->
  <div class="row mb-5">
    <div class="col-md-8">
      <h1 class="display-6 fw-bold">Gestionar Servicios</h1>
      <p class="lead text-muted">Administra los servicios que ofrece tu barbería</p>
    </div>
  </div>

  <!-- Selección de Barbería -->
  <div class="row mb-4">
    <div class="col-md-6">
      <div class="card">
        <div class="card-body">
          <label class="form-label fw-bold">Selecciona una Barbería <span class="text-danger">*</span></label>
          <select class="form-select form-select-lg" [(ngModel)]="barberiaSeleccionada" (change)="onBarberiaChange()">
            <option [value]="null">-- Selecciona una barbería --</option>
            <option *ngFor="let barberia of barberias" [value]="barberia.idBarberia">
              {{ barberia.nombre }} ({{ barberia.ciudad }})
            </option>
          </select>
        </div>
      </div>
    </div>
  </div>

  <!-- Formulario de crear/editar -->
  <div class="row mb-5" *ngIf="barberiaSeleccionada && mostrarFormulario">
    <div class="col-12">
      <div class="card">
        <div class="card-header bg-primary text-white">
          <h5 class="mb-0">{{ editandoId ? 'Editar Servicio' : 'Crear Nuevo Servicio' }}</h5>
        </div>
        <div class="card-body">
          <form [formGroup]="formulario">
            <div class="row">
              <!-- Nombre -->
              <div class="col-md-6 mb-3">
                <label class="form-label">Nombre <span class="text-danger">*</span></label>
                <input type="text" class="form-control" formControlName="nombre" placeholder="Ej: Corte de cabello">
                <small class="text-danger" *ngIf="campoNombre?.invalid && campoNombre?.touched">
                  El nombre es requerido y debe tener al menos 3 caracteres
                </small>
              </div>

              <!-- Categoría -->
              <div class="col-md-6 mb-3">
                <label class="form-label">Categoría <span class="text-danger">*</span></label>
                <select class="form-select form-select-lg" formControlName="categoria">
                  <option value="">-- Selecciona una categoría --</option>
                  <option *ngFor="let cat of categorias" [value]="cat">{{ cat }}</option>
                </select>
                <small class="text-danger" *ngIf="campoCategoria?.invalid && campoCategoria?.touched">
                  La categoría es requerida
                </small>
              </div>

              <!-- Precio -->
              <div class="col-md-6 mb-3">
                <label class="form-label">Precio <span class="text-danger">*</span></label>
                <div class="input-group input-group-lg">
                  <span class="input-group-text">$</span>
                  <input type="number" class="form-control" formControlName="precio" placeholder="0.00" step="0.01" min="0">
                </div>
                <small class="text-danger" *ngIf="campoPrecio?.invalid && campoPrecio?.touched">
                  El precio es requerido y debe ser mayor a 0
                </small>
              </div>

              <!-- Duración -->
              <div class="col-md-6 mb-3">
                <label class="form-label">Duración (minutos) <span class="text-danger">*</span></label>
                <input type="number" class="form-control form-control-lg" formControlName="duracion" placeholder="30" min="1">
                <small class="text-danger" *ngIf="campoDuracion?.invalid && campoDuracion?.touched">
                  La duración es requerida y debe ser mayor a 0
                </small>
              </div>

              <!-- Descripción -->
              <div class="col-12 mb-3">
                <label class="form-label">Descripción</label>
                <textarea class="form-control" formControlName="descripcion" rows="3" placeholder="Describe el servicio..."></textarea>
              </div>

              <!-- Destacado -->
              <div class="col-md-6 mb-3">
                <div class="form-check form-switch">
                  <input class="form-check-input" type="checkbox" formControlName="destacado" id="destacado">
                  <label class="form-check-label" for="destacado">
                    Marcar como servicio destacado
                  </label>
                </div>
              </div>

              <!-- Activo -->
              <div class="col-md-6 mb-3">
                <div class="form-check form-switch">
                  <input class="form-check-input" type="checkbox" formControlName="activo" id="activo">
                  <label class="form-check-label" for="activo">
                    Servicio activo
                  </label>
                </div>
              </div>
            </div>

            <!-- Botones -->
            <div class="row">
              <div class="col-12">
                <button type="button" class="btn btn-success btn-lg me-2" (click)="guardarServicio()" [disabled]="cargando">
                  <i class="bi bi-check-circle"></i> {{ editandoId ? 'Actualizar' : 'Crear' }}
                </button>
                <button type="button" class="btn btn-secondary btn-lg" (click)="cancelarEdicion()">
                  Cancelar
                </button>
              </div>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>

  <!-- Botón para agregar nuevo servicio -->
  <div class="row mb-4" *ngIf="barberiaSeleccionada && !mostrarFormulario">
    <div class="col-12">
      <button class="btn btn-primary btn-lg" (click)="toggleFormulario()">
        <i class="bi bi-plus-circle"></i> Nuevo Servicio
      </button>
    </div>
  </div>

  <!-- Filtros y búsqueda -->
  <div class="row mb-4" *ngIf="barberiaSeleccionada">
    <div class="col-md-6">
      <div class="input-group input-group-lg">
        <input type="text" class="form-control" placeholder="Buscar por nombre o descripción..."
               [(ngModel)]="busqueda" (keyup)="aplicarFiltros()">
        <button class="btn btn-primary" type="button" (click)="aplicarFiltros()">
          <i class="bi bi-search"></i>
        </button>
      </div>
    </div>
    <div class="col-md-6">
      <select class="form-select form-select-lg" [(ngModel)]="filtroCategoria" (change)="aplicarFiltros()">
        <option value="">Todas las categorías</option>
        <option *ngFor="let cat of categorias" [value]="cat">{{ cat }}</option>
      </select>
    </div>
  </div>

  <!-- Tabla para desktop -->
  <div class="d-none d-md-block" *ngIf="barberiaSeleccionada && serviciosFiltrados.length > 0">
    <div class="table-responsive">
      <table class="table table-hover">
        <thead class="table-light">
          <tr>
            <th>Nombre</th>
            <th>Categoría</th>
            <th>Precio</th>
            <th>Duración</th>
            <th>Destacado</th>
            <th>Acciones</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let servicio of serviciosFiltrados">
            <td class="fw-bold">{{ servicio.nombre }}</td>
            <td>{{ servicio.categoria }}</td>
            <td class="text-success fw-bold">${{ servicio.precio | number: '1.2-2' }}</td>
            <td>{{ servicio.duracionMinutos || servicio.duracion }} min</td>
            <td>
              <span class="badge bg-warning" *ngIf="servicio.destacado">Destacado</span>
              <span class="badge bg-secondary" *ngIf="!servicio.destacado">Regular</span>
            </td>
            <td>
              <div class="btn-group btn-group-sm" role="group">
                <button class="btn btn-outline-primary" (click)="editarServicio(servicio)" title="Editar">
                  <i class="bi bi-pencil"></i>
                </button>
                <button class="btn btn-outline-warning" (click)="toggleDestacado(servicio)" title="Cambiar destacado">
                  <i class="bi" [ngClass]="servicio.destacado ? 'bi-star-fill' : 'bi-star'"></i>
                </button>
                <button class="btn btn-outline-danger" (click)="eliminarServicio(servicio.idServicio)" title="Eliminar">
                  <i class="bi bi-trash"></i>
                </button>
              </div>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>

  <!-- Tarjetas para móvil -->
  <div class="d-md-none" *ngIf="barberiaSeleccionada && serviciosFiltrados.length > 0">
    <div class="row g-3">
      <div class="col-12" *ngFor="let servicio of serviciosFiltrados">
        <div class="card">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-start mb-2">
              <h6 class="card-title fw-bold">{{ servicio.nombre }}</h6>
              <span class="badge bg-warning" *ngIf="servicio.destacado">Destacado</span>
            </div>
            <div class="row text-sm mb-3">
              <div class="col-6">
                <span class="text-muted small d-block">Categoría</span>
                <strong>{{ servicio.categoria }}</strong>
              </div>
              <div class="col-6">
                <span class="text-muted small d-block">Duración</span>
                <strong>{{ servicio.duracionMinutos || servicio.duracion }} min</strong>
              </div>
              <div class="col-12">
                <span class="text-muted small d-block">Precio</span>
                <strong class="text-success h5">${{ servicio.precio | number: '1.2-2' }}</strong>
              </div>
            </div>
            <div class="d-grid gap-2">
              <button class="btn btn-sm btn-primary" (click)="editarServicio(servicio)">
                <i class="bi bi-pencil"></i> Editar
              </button>
              <button class="btn btn-sm btn-warning" (click)="toggleDestacado(servicio)">
                <i class="bi" [ngClass]="servicio.destacado ? 'bi-star-fill' : 'bi-star'"></i>
                {{ servicio.destacado ? 'Quitar destacado' : 'Destacar' }}
              </button>
              <button class="btn btn-sm btn-danger" (click)="eliminarServicio(servicio.idServicio)">
                <i class="bi bi-trash"></i> Eliminar
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Mensaje cuando no hay resultados -->
  <div *ngIf="barberiaSeleccionada && !cargando && serviciosFiltrados.length === 0" class="alert alert-info text-center py-5">
    <i class="bi bi-scissors display-4"></i>
    <h4 class="mt-3">No hay servicios configurados</h4>
    <p class="text-muted">Crea los servicios que ofrece tu barbería</p>
  </div>

  <!-- Indicador de carga -->
  <div *ngIf="cargando" class="text-center py-5">
    <div class="spinner-border text-primary mb-3" role="status">
      <span class="visually-hidden">Cargando...</span>
    </div>
    <p class="text-muted">Cargando servicios...</p>
  </div>

  <!-- Mensaje cuando no hay barbería seleccionada -->
  <div *ngIf="!barberiaSeleccionada && !cargando" class="alert alert-warning text-center py-5">
    <i class="bi bi-info-circle display-4"></i>
    <h4 class="mt-3">Selecciona una barbería</h4>
    <p class="text-muted">Para gestionar servicios, debes seleccionar una barbería primero</p>
  </div>
</div>
